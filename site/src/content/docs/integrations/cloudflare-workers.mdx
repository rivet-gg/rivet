# Cloudflare Workers

Deploy Rivet Actors to Cloudflare Workers with Durable Objects for global edge computing with persistent state.

## Feature Support

| Feature | Supported |
| --- | --- |
| Horizontal scaling | Yes |
| WebSockets | Yes |
| SSE | Yes |
| Edge | Yes |
| Scheduling | Yes |

## Setup

<Steps>
<Step title="Install packages">

Install the Cloudflare Workers driver:

```bash
npm install @rivetkit/cloudflare-workers
```

</Step>

<Step title="Configure the driver">

Update your server code to support Cloudflare Workers:

<Tabs>
<Tab title="Hono">

```typescript {{"title":"server.ts"}}
import { createHandler, type Client } from "@rivetkit/cloudflare-workers";
import { Hono } from "hono";
import { registry } from "./registry";

// Setup router
const app = new Hono<{ Bindings: { RIVET: Client<typeof registry> } }>();

// Example HTTP endpoint
app.post("/increment/:name", async (c) => {
	console.log("env", c.env);
	const client = c.env.RIVET;

	const name = c.req.param("name");

	const counter = client.counter.getOrCreate(name);
	const newCount = await counter.increment(1);

	return c.text(`New Count: ${newCount}`);
});

const { handler, ActorHandler } = createHandler(registry, { fetch: app.fetch });
export { handler as default, ActorHandler };
```

</Tab>

<Tab title="No Router">

```typescript {{"title":"server.ts"}}
import { createHandler } from "@rivetkit/cloudflare-workers";
import { registry } from "./registry";

const { handler, ActorHandler } = createHandler(registry);
export { handler as default, ActorHandler };
```

</Tab>
</Tabs>

</Step>

<Step title="Configure Wrangler">

Update your `wrangler.json` configuration to support `ACTOR_DO` and `ACTOR_KV` bindings:

```json {{"title":"wrangler.json"}}
{
  "name": "my-rivetkit-app",
  "main": "src/index.ts",
  "compatibility_date": "2025-01-20",
  "compatibility_flags": ["nodejs_compat", "enable_request_signal"],
  "migrations": [
    {
      "tag": "v1",
      "new_classes": ["ActorHandler"]
    }
  ],
  "durable_objects": {
    "bindings": [
      {
        "name": "ACTOR_DO",
        "class_name": "ActorHandler"
      }
    ]
  },
  "kv_namespaces": [
    {
      "binding": "ACTOR_KV",
      "id": "your_namespace_id"
    }
  ]
}
```

<Note>
	`enable_request_signal` compatibility flags is required if using SSE. Without it, SSE connections will never abort.
</Note>

**Configuration Requirements:**

- `ACTOR_DO` - Durable Object binding for actor persistence
- `ACTOR_KV` - KV namespace binding for metadata storage
- `nodejs_compat` - Required compatibility flag
- Migration with `ActorHandler` class definition

</Step>

<Step title="Deploy">

Deploy your application to Cloudflare Workers:

```bash
wrangler deploy
```

Your actors will now run on Cloudflare's global edge network with persistent state backed by Durable Objects.

</Step>
</Steps>

## Examples

<CardGroup>
<Card title="Cloudflare Workers + Hono" href="https://github.com/rivet-gg/rivetkit/tree/main/examples/cloudflare-workers-hono" target="_blank">
Example using Cloudflare Workers with Hono web framework.
</Card>

<Card title="Cloudflare Workers Basic" href="https://github.com/rivet-gg/rivetkit/tree/main/examples/cloudflare-workers" target="_blank">
Basic Cloudflare Workers setup and configuration example.
</Card>
</CardGroup>

<Note>
	Cloudflare Workers mounts the Rivet endpoint on `/rivet` by default.
</Note>

## Advanced

### Accessing Environment Bindings

You can access Cloudflare Workers environment bindings directly using the importable `env`:

```typescript
import { env } from "cloudflare:workers";

// Access environment variables and secrets in top-level scope
const API_KEY = env.API_KEY;
const LOG_LEVEL = env.LOG_LEVEL || "info";

// Use bindings in your actor
const myActor = actor({
  state: { count: 0 },
  
  actions: {
    // Access KV, D1, or other bindings during request handling
    getFromKV: async (c, key: string) => {
      // Access additional KV namespaces defined in wrangler.json
      if (env.MY_CACHE_KV) {
        return await env.MY_CACHE_KV.get(key);
      }
    }
  }
});
```

### Driver Context

The Cloudflare Workers driver provides access to the Durable Object state and environment through the driver context in `createVars`.

```typescript
import { actor, ActorInitContext } from "rivetkit";
import type { DriverContext } from "@rivetkit/cloudflare-workers";

const myActor = actor({
  state: { count: 0 },
  
  // Save the Cloudflare driver context
  createVars: (ctx: ActorInitContext, driver: DriverContext) => ({ 
    state: driver.state,
  }),
  
  actions: {
    // Example: Access Durable Object info (not recommended in practice)
    kvGet: (c, key: string) => {
      const doState = c.vars.state;
	  return await doState.storage.get(key)
    },
  }
});
```

The Cloudflare Workers driver context type is exported as `DriverContext` from `@rivetkit/cloudflare-workers`:

```typescript
interface DriverContext {
  state: DurableObjectState;
}
```

<Warning>
While you have access to the Durable Object state, be cautious when directly modifying KV storage or alarms, as this may interfere with RivetKit's internal operations and potentially break actor functionality.
</Warning>

